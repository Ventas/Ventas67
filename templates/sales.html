<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Venta de productos</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f2f5;
      color: #333;
      padding-bottom: 50px;
    }

    .container-custom {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }

    .barcode-section, .form-container, .sales-summary, .sales-history {
      background-color: #ffffff;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }

    .sales-table th {
      background-color: #007bff;
      color: white;
    }

    .sales-summary {
      background: linear-gradient(to right, #e3f2fd, #f0faff);
      border-left: 6px solid #007bff;
    }

    .export-buttons button {
      width: 100%;
    }

    @media (min-width: 768px) {
      .export-buttons button {
        width: auto;
      }
    }

    #change_display {
      font-size: 22px;
      color: #28a745;
      font-weight: bold;
      background-color: #e9fce9;
      padding: 10px 15px;
      border-radius: 10px;
      display: inline-block;
    }
  </style>
</head>
<body>
<div class="container-custom">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4">Venta de Productos</h1>
    <a href="/menu" class="btn btn-secondary">‚¨ÖÔ∏è Volver al men√∫</a>
  </div>

<div class="barcode-section">
    <h3>‚öñÔ∏è Balanza Digital</h3>
    <div class="mb-3">
        <label for="serial-port" class="form-label">Configuraci√≥n del Puerto Serial:</label>
        
        <!-- Selector de puerto serial con opci√≥n manual -->
        <div class="input-group mb-2">
            <select id="serial-port" class="form-select">
                <option value="">Seleccionar puerto...</option>
                <option value="manual">Ingresar manualmente</option>
            </select>
            <button class="btn btn-outline-secondary" type="button" onclick="refreshSerialPorts()">
                <i class="bi bi-arrow-clockwise"></i> Actualizar
            </button>
        </div>
        
        <!-- Campo para entrada manual (oculto inicialmente) -->
        <div id="manual-port-container" class="mb-3" style="display: none;">
            <label for="manual-port" class="form-label">Nombre del puerto:</label>
            <input type="text" id="manual-port" class="form-control" placeholder="Ej: COM3, /dev/ttyUSB0">
        </div>
        
        <!-- Selector de baudrate -->
        <div class="mb-3">
            <label for="baudrate" class="form-label">Velocidad (baudrate):</label>
            <select id="baudrate" class="form-select">
                <option value="9600">9600</option>
                <option value="19200">19200</option>
                <option value="38400">38400</option>
                <option value="57600">57600</option>
                <option value="115200">115200</option>
            </select>
        </div>
    </div>
    
    <!-- Estado de conexi√≥n -->
    <div id="scale-status" class="alert alert-secondary mb-3">
        <i class="bi bi-usb-symbol"></i> Balanza no conectada
    </div>
    
    <!-- Display de peso -->
    <div class="mb-3 p-3 bg-light border rounded text-center">
        <h4 id="weight-display">0.000 kg</h4>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="auto-update-check" checked>
            <label class="form-check-label" for="auto-update-check">Actualizaci√≥n autom√°tica</label>
        </div>
    </div>
    
    <!-- Botones de control -->
    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
        <button id="connect-btn" class="btn btn-primary" onclick="connectScale()">
            <i class="bi bi-plug"></i> Conectar
        </button>
        <button id="disconnect-btn" class="btn btn-danger" onclick="disconnectScale()" disabled>
            <i class="bi bi-plug-fill"></i> Desconectar
        </button>
        <button id="tare-btn" class="btn btn-warning" onclick="sendTareCommand()" disabled>
            <i class="bi bi-arrow-counterclockwise"></i> Tara
        </button>
    </div>
</div>

  <!-- Formulario de venta -->
  <form method="post" action="/process-sale" onsubmit="return validateForm()">
    <div class="row g-4">
      <div class="col-md-8">
        <div class="form-container">
          <h3>üõí Productos</h3>
          <table class="table table-striped table-bordered sales-table">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Stock</th>
                <th>Precio Unitario</th>
                <th>IVA %</th>
                <th>Subtotal</th>
                <th>Eliminar</th>
              </tr>
            </thead>
            <tbody id="summary-body">
              <!-- din√°mico -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-container">
          <h3>üí≥ Pago</h3>
          <div class="mb-3">
            <label for="payment_method" class="form-label">M√©todo de pago:</label>
            <select name="payment_method" id="payment_method" class="form-select" required>
              <option value="">Seleccione...</option>
              <option value="efectivo">Efectivo</option>
              <option value="tarjeta">Tarjeta</option>
              <option value="Nequi">Nequi</option>
              <option value="Daviplata">Daviplata</option>
              <option value="Bancolombia">Bancolombia</option>
            </select>
          </div>
          <div class="mb-3">
            <label>Subtotal:</label>
            <div id="subtotal_display">$0.00</div>
        </div>
        <div class="mb-3">
            <label>IVA:</label>
            <div id="iva_display">$0.00</div>
        </div>
        <div class="mb-3">
            <label>Total a pagar:</label>
            <div id="total_display">$0.00</div>
        </div>  
          <div class="mb-3">
            <label for="money_received" class="form-label">Dinero recibido:</label>
            <input type="number" step="0.01" id="money_received" name="money_received" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Total a pagar:</label>
            <div id="total_display">$0.00</div>
          </div>
          <div class="mb-3">
            <label>Dinero a devolver:</label>
            <div id="change_display">$0.00</div>
          </div>
          <button type="submit" class="btn btn-primary w-100">üíæ Registrar venta</button>
        </div>
      </div>
    </div>
  </form>

  <!-- Resultados -->
  {% if result %}
  <div class="form-container">
    <h2>Resultado:</h2>
    {% if result.status == "ok" %}
    <p><strong>Total:</strong> ${{ result.total }}</p>
    <p><strong>Cambio:</strong> ${{ result.change }}</p>
    <div class="d-flex flex-wrap gap-3 mt-3">
      <button type="button" class="btn btn-info" onclick="printThermalTicket({{ result.sale_id }})">üñ®Ô∏è Imprimir Ticket</button>
      <button type="button" class="btn btn-success" onclick="downloadTicketPDF({{ result.sale_id }})">üìÑ Guardar PDF</button>
    </div>
    {% else %}
    <p class="text-danger fw-semibold">{{ result.message }}</p>
    {% endif %}
  </div>
  {% endif %}

  <!-- Resumen del d√≠a -->
  <div class="sales-summary">
    <h2>üßæResumen del d√≠a</h2>
    <ul class="list-unstyled">
      <li><strong>Total vendido:</strong> ${{ resumen.total_vendido }}</li>
      <li><strong>Productos vendidos:</strong> {{ resumen.productos_vendidos }}</li>
      <li><strong>N√∫mero de ventas:</strong> {{ resumen.numero_ventas }}</li>
    </ul>
  </div>

  <!-- Exportaci√≥n -->
  <div class="row export-buttons mb-4">
    <div class="col-6 col-md-3">
      <a href="/export-sales-excel" class="btn btn-success"><i class="bi bi-file-earmark-excel me-2"></i>Exportar Excel</a>
    </div>
    <div class="col-6 col-md-3">
      <a href="/export-sales-pdf"  class="btn btn-danger"><i class="bi bi-file-earmark-pdf me-2"></i>Exportar PDF</a>
    </div>
    <div class="col-md-6 mt-3 mt-md-0">
      <form action="/export-sales-by-date" method="get" class="d-flex flex-column flex-md-row align-items-md-center gap-2">
        <label for="selected_date" class="form-label fw-bold">Por fecha:</label>
        <input type="date" id="selected_date" name="selected_date" class="form-control" required>
        <button type="submit" class="btn btn-primary"><i class="bi bi-download me-2"></i>Exportar</button>
      </form>
    </div>
  </div>

  <!-- Historial -->
  <div class="sales-history">
    <h2>üßæHistorial de ventas</h2>
    <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Total</th>
            <th>M√©todo de Pago</th>
            <th>Fecha</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody>
          {% for v in ventas %}
          <tr>
            <td>{{ v.product.nombre }}</td>
            <td>{{ v.quantity }}</td>
            <td>${{ v.total }}</td>
            <td>{{ v.payment_method }}</td>
            <td>{{ v.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>
              <form method="post" action="/delete-sale" onsubmit="return confirm('¬øSeguro que deseas eliminar esta venta?');">
                <input type="hidden" name="sale_id" value="{{ v.id }}">
                <button type="submit" class="btn btn-sm btn-danger">‚ùå Eliminar</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<script>

  let currentWeight = 0;
  let selectedProduct = null;
  let scaleConnected = false;
  let selectedWeightProduct = null;
  let weightUpdateInterval = null;
// Actualizar lista de puertos seriales
async function refreshSerialPorts() {
    try {
        const response = await fetch('/serial-ports');
        const data = await response.json();
        
        const select = document.getElementById('serial-port');
        
        // Guardar la selecci√≥n actual
        const currentSelection = select.value;
        
        // Limpiar y agregar opciones b√°sicas
        select.innerHTML = '<option value="">Seleccionar puerto...</option>' +
                          '<option value="manual">Ingresar manualmente</option>';
        
        // Agregar puertos detectados
        data.ports.forEach(port => {
            const option = document.createElement('option');
            option.value = port.device;
            option.textContent = `${port.device} - ${port.description || 'Sin descripci√≥n'}`;
            select.appendChild(option);
        });
        
        // Restaurar selecci√≥n si a√∫n existe
        if (currentSelection && Array.from(select.options).some(o => o.value === currentSelection)) {
            select.value = currentSelection;
            handlePortSelection();
        }
        
        // Habilitar/deshabilitar bot√≥n de conexi√≥n
        document.getElementById('connect-btn').disabled = select.value === '';
        
    } catch (error) {
        console.error('Error al obtener puertos seriales:', error);
        alert('Error al obtener puertos seriales. Verifica la consola para m√°s detalles.');
    }
}

// Manejar selecci√≥n de puerto
function handlePortSelection() {
    const select = document.getElementById('serial-port');
    const manualContainer = document.getElementById('manual-port-container');
    
    if (select.value === 'manual') {
        manualContainer.style.display = 'block';
        document.getElementById('manual-port').focus();
    } else {
        manualContainer.style.display = 'none';
    }
    
    // Habilitar bot√≥n de conexi√≥n si hay un puerto seleccionado
    document.getElementById('connect-btn').disabled = select.value === '';
}

// Conectar a la balanza
async function connectScale() {
    const portSelect = document.getElementById('serial-port');
    let port;
    
    if (portSelect.value === 'manual') {
        port = document.getElementById('manual-port').value.trim();
        if (!port) {
            alert('Por favor ingresa un nombre de puerto v√°lido');
            return;
        }
    } else {
        port = portSelect.value;
    }
    
    const baudrate = document.getElementById('baudrate').value;
    
    try {
        const response = await fetch('/connect-scale', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                port: port,
                baudrate: parseInt(baudrate)
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Error al conectar con la balanza');
        }
        
        const data = await response.json();
        if (data.status === 'connected') {
            scaleConnected = true;
            updateScaleUI(true);
            startWeightUpdates();
            alert(`Conectado exitosamente al puerto ${port}`);
        }
    } catch (error) {
        console.error('Error al conectar:', error);
        alert(`Error al conectar: ${error.message}`);
        updateScaleUI(false);
    }
}

// Inicializar al cargar la p√°gina
document.addEventListener('DOMContentLoaded', () => {
    refreshSerialPorts();
    
    // Event listener para el selector de puerto
    document.getElementById('serial-port').addEventListener('change', handlePortSelection);
    
    // Event listener para el campo manual
    document.getElementById('manual-port').addEventListener('input', function() {
        document.getElementById('connect-btn').disabled = this.value.trim() === '';
    });
});
// Desconectar la balanza
async function disconnectScale() {
    try {
        // Detener las actualizaciones
        stopWeightUpdates();
        
        // Enviar comando para desconectar (el backend cerrar√° la conexi√≥n)
        await fetch('/disconnect-scale');
        
        scaleConnected = false;
        updateScaleUI(false);
    } catch (error) {
        console.error('Error al desconectar:', error);
    }
}

// Enviar comando de tara
async function sendTareCommand() {
    if (!scaleConnected) return;
    
    try {
        await fetch('/tare-scale');
        // La pr√≥xima lectura mostrar√° el peso con tara
    } catch (error) {
        console.error('Error al enviar tara:', error);
    }
}

// Iniciar actualizaciones peri√≥dicas del peso
function startWeightUpdates() {
    if (weightUpdateInterval) clearInterval(weightUpdateInterval);
    
    weightUpdateInterval = setInterval(async () => {
        if (!document.getElementById('auto-update-check').checked) return;
        
        try {
            const response = await fetch('/read-scale');
            const data = await response.json();
            
            if (data.weight !== undefined) {
                currentWeight = data.weight;
                updateWeightDisplay();
                
                // Si hay un producto de peso seleccionado, actualizar su cantidad
                if (selectedWeightProduct) {
                    updateProductQuantity(selectedWeightProduct, currentWeight);
                }
            }
        } catch (error) {
            console.error('Error al leer peso:', error);
        }
    }, 500); // Actualizar cada 500ms
}

// Detener actualizaciones de peso
function stopWeightUpdates() {
    if (weightUpdateInterval) {
        clearInterval(weightUpdateInterval);
        weightUpdateInterval = null;
    }
}

// Actualizar la UI seg√∫n el estado de conexi√≥n
function updateScaleUI(connected) {
    const statusElement = document.getElementById('scale-status');
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    const tareBtn = document.getElementById('tare-btn');
    
    if (connected) {
        statusElement.className = 'alert alert-success mb-3';
        statusElement.innerHTML = '<i class="bi bi-check-circle"></i> Balanza conectada';
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        tareBtn.disabled = false;
    } else {
        statusElement.className = 'alert alert-secondary mb-3';
        statusElement.innerHTML = '<i class="bi bi-usb-symbol"></i> Balanza no conectada';
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        tareBtn.disabled = true;
        document.getElementById('weight-display').textContent = '0.000 kg';
    }
}

// Actualizar el display de peso
function updateWeightDisplay() {
    const weightDisplay = document.getElementById('weight-display');
    weightDisplay.textContent = currentWeight.toFixed(3) + ' kg';
    
    // Cambiar color si el peso es negativo
    if (currentWeight < 0) {
        weightDisplay.style.color = 'red';
    } else {
        weightDisplay.style.color = '';
    }
}
// Simulador de lectura de balanza (reemplazar con conexi√≥n real)

// Funci√≥n para manejar la selecci√≥n de producto
function onProductSelected(product) {
    const isWeightProduct = product.unidad_stock.toLowerCase().includes('kg') || 
                          product.unidad_stock.toLowerCase().includes('gr') ||
                          product.unidad_stock.toLowerCase().includes('g');
    
    if (isWeightProduct) {
        selectedWeightProduct = product;
        document.getElementById('weight-product-info').classList.remove('d-none');
        document.getElementById('weight-product-name').textContent = product.nombre;
        
        // Si la balanza est√° conectada, agregar el producto con el peso actual
        if (scaleConnected) {
            addProduct(product);
        }
    } else {
        selectedWeightProduct = null;
        document.getElementById('weight-product-info').classList.add('d-none');
    }
}

// Inicializar al cargar la p√°gina
document.addEventListener('DOMContentLoaded', () => {
    refreshSerialPorts();
});

// Funci√≥n para actualizar la cantidad del producto en la tabla
function updateProductQuantity(product, weight) {
    const tbody = document.getElementById('summary-body');
    const rows = tbody.getElementsByTagName('tr');
    
    // Buscar si el producto ya est√° en la tabla
    for (let row of rows) {
        const productName = row.querySelector('input[name="product"]').value;
        if (productName === product.nombre) {
            const qtyInput = row.querySelector('input[name="quantity"]');
            qtyInput.value = weight.toFixed(3);
            calculateTotals();
            return;
        }
    }
    
    // Si no est√° en la tabla, agregarlo
    addProduct(product);
}

// Modificar la funci√≥n addProduct
function addProduct(product = null) {
    if (!product) {
        const search = document.getElementById('search').value.toLowerCase();
        product = productos.find(p => p.nombre.toLowerCase().includes(search));
        if (!product) {
            alert("Producto no encontrado");
            return;
        }
    }

    const tbody = document.getElementById('summary-body');
    
    const existingRow = Array.from(tbody.rows).find(row => {
        return row.querySelector('input[name="product"]').value === product.nombre;
    });

    if (existingRow) {
        const qtyInput = existingRow.querySelector('input[name="quantity"]');
        const currentQty = parseFloat(qtyInput.value);
        const newQty = currentQty + (isWeightProduct ? currentWeight : 1);
        qtyInput.value = newQty;
        qtyInput.dispatchEvent(new Event('change'));
        return;
    }

    const isWeightProduct = product.unidad_stock.toLowerCase().includes('kg') || 
                          product.unidad_stock.toLowerCase().includes('gr') ||
                          product.unidad_stock.toLowerCase().includes('g');

    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <input type="hidden" name="product" value="${product.nombre}" data-iva="${product.iva}">
            ${product.nombre}
        </td>
        <td>
            <input type="number" name="quantity" value="${isWeightProduct ? currentWeight.toFixed(3) : 1}" 
                   step="${isWeightProduct ? '0.001' : '1'}" 
                   ${!isWeightProduct ? `max="${product.stock}"` : ''} 
                   onchange="calculateTotals()"
                   ${isWeightProduct ? 'readonly' : ''}>
        </td>
        <td>${product.stock} ${product.unidad_stock}</td>
        <td>$${product.precio.toFixed(2)}</td>
        <td>${product.iva || 0}%</td>
        <td class="subtotal">$${(product.precio * (isWeightProduct ? currentWeight : 1)).toFixed(2)}</td>
        <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">‚ùå</button></td>
    `;

    tbody.appendChild(row);
    calculateTotals();
    
    if (isWeightProduct) {
        selectedProduct = product;
        document.getElementById('weight-product-info').style.display = 'block';
        document.getElementById('weight-product-name').textContent = product.nombre;
    }
}


// Iniciar la lectura de la balanza al cargar la p√°gina
document.addEventListener('DOMContentLoaded', () => {
    simulateScaleReading(); // Reemplazar con la conexi√≥n real a la balanza
});

// Modificar la funci√≥n de b√∫squeda para manejar selecci√≥n de productos
function filterProducts() {
    const search = document.getElementById('search').value.toLowerCase();
    const options = productos.filter(p => p.nombre.toLowerCase().includes(search));
    
    if (options.length === 1) {
        onProductSelected(options[0]);
    } else {
        // Si no hay coincidencia exacta, deseleccionar
        selectedProduct = null;
        document.getElementById('weight-product-info').style.display = 'none';
    }
}
    const productos = [
        {% for p in productos %}
        {
            nombre: "{{ p.nombre }}",
            precio: {{ p.precio }},
            stock: {{ p.stock }},
            iva: {{ p.iva }},  // ¬°Aseg√∫rate de incluir este campo!
            unidad_stock: "{{ p.unidad_stock }}",
            codigo_barras: "{{ p.codigo_barras if p.codigo_barras else '' }}"
        },
        {% endfor %}
    ];

    function filterProducts() {
        const search = document.getElementById('search').value.toLowerCase();
        const options = productos.filter(p => p.nombre.toLowerCase().includes(search));
        if (options.length === 1) {
            addProduct(options[0]);
            document.getElementById('search').value = '';  // limpia el input
        }
    }


function removeRow(button) {
    const row = button.closest('tr');
    row.remove();
    calculateTotals();
}

function calculateTotals() {
    let subtotal = 0;
    let ivaTotal = 0;

    const rows = document.querySelectorAll('#summary-body tr');
    rows.forEach(row => {
        const price = parseFloat(row.children[3].textContent.replace('$', ''));
        const qtyInput = row.querySelector('input[name="quantity"]');
        const quantity = parseFloat(qtyInput.value);
        const maxStock = parseFloat(qtyInput.getAttribute("max"));
        
        const ivaInput = row.querySelector('input[name="product"]');
        const ivaPercentage = parseFloat(ivaInput.getAttribute('data-iva')) || 0;

        if (!isNaN(maxStock) && quantity > maxStock) {
            alert(`La cantidad ingresada para "${row.children[0].textContent.trim()}" supera el stock disponible (${maxStock}).`);
            qtyInput.value = maxStock;
            return;
        }

        const productSubtotal = price * quantity;
        const productIva = productSubtotal * (ivaPercentage / 100);
        const productTotal = productSubtotal + productIva;

        const subtotalCell = row.querySelector('.subtotal');
        subtotalCell.textContent = `$${productTotal.toFixed(2)}`;

        subtotal += productSubtotal;
        ivaTotal += productIva;
    });

    let total = subtotal + ivaTotal;
    
    // Redondear a los 50 m√°s cercanos (hacia arriba)
    const redondeo = 50; // Redondear a m√∫ltiplos de 50
    total = Math.ceil(total / redondeo) * redondeo;
    
    // Si quieres que 1750 se mantenga como 1750 (en lugar de subir a 1800)
    // puedes usar esta versi√≥n alternativa:
    // const residuo = total % redondeo;
    // total = residuo > 0 ? total + (redondeo - residuo) : total;

    // Actualizar displays
    document.getElementById('subtotal_display').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('iva_display').textContent = `$${ivaTotal.toFixed(2)}`;
    document.getElementById('total_display').textContent = `$${total.toFixed(2)}`;

    // Calcular cambio
    const moneyReceived = parseFloat(document.getElementById('money_received').value) || 0;
    const change = moneyReceived - total;
    
    // Mostrar el cambio
    const changeDisplay = document.getElementById('change_display');
    changeDisplay.textContent = `$${Math.abs(change).toFixed(2)}`;

    if (change < 0) {
        changeDisplay.style.color = '#dc3545';
        changeDisplay.style.backgroundColor = '#ffe6e6';
    } else {
        changeDisplay.style.color = '#28a745';
        changeDisplay.style.backgroundColor = '#e9fce9';
    }
}

// Agregar event listeners
document.getElementById('money_received').addEventListener('input', calculateTotals);
document.getElementById('money_received').addEventListener('change', calculateTotals);

// Inicializar al cargar la p√°gina
document.addEventListener('DOMContentLoaded', calculateTotals);
    // Funci√≥n para manejar el escaneo de c√≥digo de barras
    async function scanBarcode() {
        const barcode = document.getElementById('barcode-input').value.trim();
        if (!barcode) return;
        
        try {
            // Opci√≥n 1: Buscar directamente en los productos cargados
            const producto = productos.find(p => p.codigo_barras === barcode);
            
            if (producto) {
                addProduct(producto);
                document.getElementById('barcode-input').value = '';
                document.getElementById('barcode-input').focus();
            } else {
                // Opci√≥n 2: Hacer una petici√≥n al servidor si no se encuentra localmente
                const response = await fetch('/get-product-by-barcode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `barcode=${encodeURIComponent(barcode)}`
                });
                
                const data = await response.json();
                
                if (data.status === "ok") {
                    addProduct(data.product);
                    document.getElementById('barcode-input').value = '';
                    document.getElementById('barcode-input').focus();
                } else {
                    alert(data.message || "Producto no encontrado");
                }
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error al buscar el producto");
        }
    }

    // Configurar eventos del esc√°ner
    document.getElementById('barcode-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            scanBarcode();
        }
    });

    let barcodeTimer;
    document.getElementById('barcode-input').addEventListener('input', function(e) {
        clearTimeout(barcodeTimer);
        barcodeTimer = setTimeout(() => {
            if (this.value.length > 3) {
                scanBarcode();
            }
        }, 100);
    });

  function printThermalTicket(saleId) {
    console.log("Intentando imprimir ticket con ID:", saleId);
    const printWindow = window.open(`/thermal-ticket/${saleId}`, '_blank', 'width=320,height=600');
    
    if (!printWindow) {
        alert("Por favor permite ventanas emergentes para imprimir el ticket");
        window.location.href = `/thermal-ticket/${saleId}`;
    }
}

function downloadTicketPDF(saleId) {
    console.log("Descargando PDF para venta ID:", saleId);
    window.open(`/ticket/${saleId}`, '_blank');
}
function updateManualWeight() {
    const input = document.getElementById('manual-weight');
    const weight = parseFloat(input.value) || 0;
    currentWeight = weight;

    // Si hay un producto seleccionado por peso, actualizar su cantidad
    if (selectedProduct) {
        updateProductQuantity(selectedProduct, currentWeight);
    }
}
</script>
<div style="text-align: center; margin-top: 40px;">
    <a href="/menu">
        <button type="button" style="background-color: #6c757d; padding: 12px 24px; font-size: 16px; border-radius: 8px;">
            ‚¨ÖÔ∏è Volver al men√∫
        </button>
    </a>
</div>

</body>
</html>